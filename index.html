<!DOCTYPE html>
<html>
  <head>
    <title>Hello World!</title>
  </head>
  <body>
    <h1>Hello World!</h1>
    <div>voice</div>
    <div id="app">
      <svg v-attr="width: width, height : height, viewBox: viewBox">
        <path stroke="black" width=1 fill="transparent" v-attr="d:points"></path>
      </svg>
    </div>
  </body>
  <script>
  function uintToAverage(array){
    var sum = 0
    var length = array.length 
    for(var i = 0; i < length; i++){
      sum += array[i]
    }
    return sum / length
  }
  
  var Vue = require("vue")
  var vm = new Vue({
    data : {
      volumes: [],
      stream: [],
      width :100,
      height :100
    },
    computed : {
      viewBox : function(){
        return [0, -this.$data.height, this.$data.width, this.$data.height].join(" ")
      },
      points : function(){
        var pts = []
        var length =  this.$data.stream.length
        for(var i=0; i < length; i++){
          var value = this.$data.stream[i]
          var x = this.$data.width / length * i
          var y = -value * this.$data.height / 255
          pts.push(x + "," + y)
        }
        if(pts.length == 0){
          return ""
        }
        return "M"+pts.join(" ")
      }
    },
    created : function(){
      var self = this
      function success(stream){
        handleAudioProgress(stream, function(array){
          self.$data.stream = array
        })
      }
      navigator.webkitGetUserMedia({ video: false, audio: true}, success, error)
      
    }
  })
  vm.$mount("#app")
  /*
  function drawToCanvas(average){
    return 
    var canvasContext =  document.querySelector("#test").getContext("2d");
    
    canvasContext.clearRect(0, 0, 300, 130);
    canvasContext.fillStyle = '#00ff00';
    canvasContext.fillRect(0,130-average,300,130);
  }
  */
  var audioContext = new webkitAudioContext();
  var analyser = audioContext.createAnalyser();
  var javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);
  
  function handleAudioProgress(stream, onAudioProgress){
    var microphone = audioContext.createMediaStreamSource(stream);
    
    analyser.smoothingTimeConstant = 0.3;
    analyser.fftSize = 1024;
    
    microphone.connect(analyser);
    analyser.connect(javascriptNode);
    javascriptNode.connect(audioContext.destination);
    javascriptNode.onaudioprocess = function() {
      var array =  new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(array);
      onAudioProgress(array)
      //var average = uintToAverage(array)
      //drawToCanvas(average)
    } 
  }
  function error(err){
    console.log("An error occured! " + err);
  }
  </script>
</html>